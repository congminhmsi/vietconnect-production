# Version 5.4.9

**Release Date:** September 1, 2025  
**Tags:** IMAGE UPLOADS, AFFILIATE ADMIN, PUBLIC ACCESS, NAVIGATION FIXES, VALIDATION IMPROVEMENTS, ERROR HANDLING, LOGO UPLOADS, ADMIN UX

## Fixed

### Deposit Method Image Management
- **Upload Directory**: Fixed deposit method images being uploaded to incorrect directory (`/uploads/depositCompound/` instead of `/uploads/depositMethods/`)
- **Directory Mapping**: Implemented proper directory name mapping for compound columns to use meaningful folder names
- **Image Storage**: Created dedicated `depositMethods` directory for better organization of deposit method images
- **Backward Compatibility**: Migrated existing images from old directory structure to maintain functionality
- **Upload Consistency**: Ensured both DataTable drawer and manual modal use the same upload directory

### Affiliate Admin Navigation
- **Menu Structure**: Fixed missing "Rewards" menu item in affiliate admin layout
- **Broken Links**: Corrected incorrect paths in dashboard (`/admin/affiliate/conditions` â†’ `/admin/affiliate/condition`)
- **Menu Items**: Added proper menu structure with Dashboard, Referrals, Conditions, Rewards, and Settings
- **Path Consistency**: Ensured all affiliate admin pages use correct routing paths
- **Import Compliance**: Verified all pages use `@/i18n/routing` for navigation components

### Trade Page Public Access
- **KYC Requirements**: Removed unnecessary KYC verification for visitors viewing the trade page
- **Public Accessibility**: Trade page now allows visitors to view trading interface without login
- **User Experience**: Visitors can explore charts and market data without authentication barriers
- **Selective Verification**: KYC checks now only apply to logged-in users attempting to place trades
- **Market Transparency**: Enhanced platform transparency by making trading data publicly viewable

### Binary Trading Guide Icon
- **Guide Icon Removal**: Temporarily removed the guide icon from binary trading page header as requested
- **Clean Interface**: Removed GuideModal import, state management, and UI components for streamlined trading interface
- **Code Cleanup**: Eliminated unused guide-related imports and functionality from binary trading components

### User Profile Wallet Tab TypeError
- **Wallet Hook Errors**: Fixed `TypeError: Cannot read properties of undefined (reading '_internal')` on `/en/user/profile?tab=wallet`
- **Hook Initialization**: Enhanced wallet configuration to provide safe fallback values when hooks are not ready
- **Error Handling**: Added comprehensive error boundaries and null checking for wallet operations
- **Connection Safety**: Improved wallet connection handling with proper error states and recovery

### Binary Trading Sidebar Responsiveness
- **Collapsed State**: Fixed left sidebar Active Positions to show only icon when collapsed instead of full title text
- **Responsive Width**: Sidebar now properly resizes from 320px (expanded) to 64px (collapsed)
- **Icon Display**: When collapsed, shows centered BarChart3 icon with position count below
- **Smooth Transitions**: Added 200ms transitions for all sidebar state changes

### Admin System Cron Page Responsiveness
- **Mobile Layout**: Completely redesigned cron management page for mobile and tablet devices
- **Responsive Grid**: Improved card grid from `lg:grid-cols-12` to `xl:grid-cols-12` with better breakpoints
- **Timeline Visibility**: Hidden timeline component on mobile to reduce clutter while maintaining functionality on desktop
- **Header Layout**: Changed header from side-by-side to stacked layout on mobile devices
- **List View**: Added dual-layout system with desktop table and mobile card-style views
- **Search Bar**: Made search bar full-width on mobile, constrained on desktop

### Cron Job Status Management (Critical Fix)
- **Idle Status Issue**: Fixed critical bug where all cron jobs permanently showed as "idle" despite executing correctly
- **Status Synchronization**: Enhanced CronJobManager to properly update job status fields during execution lifecycle
- **Real-time Updates**: Synchronized WebSocket broadcasts with actual job object status updates
- **Execution History**: Added execution history tracking with last 10 runs and success rates
- **Progress Tracking**: Implemented proper progress updates during job execution
- **Manual Triggering**: Added API endpoint for manually triggering cron jobs for testing purposes

### Admin Deposit Transaction Validation
- **Field-Specific Errors**: Replaced generic validation messages with specific field-level error descriptions
- **User-Friendly Messages**: Transformed technical JSON error responses into readable error text (e.g., "Reference Id must be at least 1 characters long")
- **Required Field Indication**: Added clear visual indicators (*) for required fields in transaction forms
- **Conditional Validation**: Implemented conditional validation where `referenceId` is required when status is "COMPLETED"
- **Error Display**: Added red borders and inline error messages for invalid form fields
- **Deposit Schema**: Created dedicated `depositUpdateSchema` with proper validation rules for deposit transactions

### Logo Upload System
- **Dark Logo Upload**: Fixed Dark Logo (96x96px) upload failures in admin system settings
- **PNG Processing**: Corrected Sharp image processing to use `compressionLevel` instead of invalid `quality` parameter for PNG files
- **Error Diagnostics**: Enhanced error logging with detailed debugging information for logo upload failures
- **Upload Feedback**: Improved error messages to specify which logo type failed during upload
- **File Processing**: Added comprehensive validation and error handling throughout the logo upload pipeline

### Request Validation Framework
- **Schema Validation**: Enhanced AJV-based validation to provide user-friendly error messages instead of technical JSON dumps
- **Error Parsing**: Improved error message parsing to extract meaningful validation details from backend responses
- **Field Mapping**: Added intelligent field name detection for better error message contextualization
- **Custom Validation**: Extended validation framework with custom error properties for better frontend handling

## Improved

### File Organization
- **Image Directories**: Better organized upload directories with meaningful names (e.g., `depositMethods` instead of `depositCompound`)
- **Directory Structure**: Standardized naming conventions for upload folders across different features
- **Path Mapping**: Implemented centralized directory mapping for consistent upload paths

### Navigation Consistency
- **Routing Imports**: Ensured consistent use of custom routing imports from `@/i18n/routing` across all admin pages
- **Menu Keys**: Fixed menu item keys to properly match their corresponding features
- **Icon Updates**: Updated menu icons to better represent their functions (e.g., trophy icon for Rewards)

### User Accessibility
- **Public Pages**: Improved accessibility for public-facing pages by removing unnecessary authentication barriers
- **Progressive Enhancement**: Implemented progressive access where viewing is public but actions require authentication
- **Error Prevention**: Prevented confusing KYC requirement messages for non-authenticated visitors

### Cron Management Interface
- **Grid Layout**: Updated cron job grid to maximum 3 columns instead of 4 for better detail visibility
- **Card Spacing**: Enhanced card spacing and responsive breakpoints for optimal viewing
- **Health Dashboard**: Redesigned CronHealth component with enhanced statistics and mobile-friendly layout
- **Real-time Status**: Added comprehensive real-time status tracking with visual indicators
- **Success Metrics**: Integrated success rate calculations and execution time tracking

### Binary Trading Interface
- **Sidebar UX**: Improved Active Positions sidebar with intelligent collapse behavior
- **Visual Polish**: Enhanced sidebar animations and transitions for smoother user experience
- **Space Optimization**: Better space utilization when sidebar is collapsed for maximum chart viewing area

### Mobile Responsiveness
- **Admin Cron Page**: Complete mobile optimization with touch-friendly interfaces
- **Responsive Typography**: Implemented responsive text sizing across all admin components
- **Touch Interactions**: Enhanced touch targets and mobile navigation patterns
- **Tablet Optimization**: Improved layouts for tablet devices with balanced column distributions

### Wallet Management
- **Error Recovery**: Enhanced wallet connection error handling with user-friendly messages
- **State Management**: Improved wallet state synchronization across components
- **Connection Reliability**: Better handling of wallet initialization and connection failures

### Admin User Experience
- **Form Validation**: Transaction edit forms now show real-time field-specific validation errors
- **Error Clarity**: Replaced confusing validation JSON with clear, actionable error messages
- **Visual Feedback**: Added consistent error styling with red borders and error text for failed fields
- **Field Labels**: Enhanced form labels with proper descriptions and required field indicators
- **Help Text**: Added contextual help text for complex fields like Reference ID requirements

### Error Handling Architecture
- **Backend Validation**: Improved validation error structure to support field-specific error messages
- **Frontend Processing**: Enhanced frontend error parsing to handle both legacy and new error formats
- **Debug Logging**: Added comprehensive debug logging for easier troubleshooting of validation issues
- **Error Propagation**: Improved error propagation from backend validation to frontend display

### Developer Experience
- **Schema Documentation**: Added detailed schema definitions with field descriptions and constraints
- **Error Tracing**: Enhanced error logging with stack traces and detailed context information
- **Code Organization**: Separated deposit-specific validation logic into dedicated utility files
- **Type Safety**: Improved TypeScript interfaces for better validation error handling

### System Reliability
- **Logo Processing**: More robust image processing with better error handling and recovery
- **File Validation**: Enhanced file type and size validation with clear error messages
- **Path Resolution**: Improved file path resolution with multiple fallback options for production environments
- **Debug Information**: Added detailed logging for troubleshooting upload and validation issues

## Technical Details

### New Components
- **depositUpdateSchema**: Dedicated validation schema for deposit transaction updates with conditional requirements
- **ValidationErrors Interface**: TypeScript interface for structured field-specific error handling
- **Enhanced LogoField Component**: Improved logo upload component with better error handling and user feedback
- **Cron Trigger API**: New POST endpoint `/api/admin/system/cron/trigger` for manually triggering cron jobs
- **Enhanced CronJobManager**: Added manual job triggering, execution history, and success rate tracking
- **Mobile-First Cron Interface**: Redesigned cron management with responsive layouts and touch optimization

### Backend Enhancements
- **Custom Error Properties**: Added `isValidationError` and `details` properties to validation errors for better frontend handling
- **Improved Sharp Processing**: Fixed PNG image processing configuration for logo uploads
- **Enhanced Error Messages**: Validation errors now include user-friendly messages alongside technical details
- **Conditional Schema Validation**: Implemented conditional validation rules based on transaction status
- **Cron Status Management**: Fixed CronJobManager to properly update job status fields throughout execution lifecycle
- **WebSocket Integration**: Enhanced broadcast system to synchronize with actual job object status updates
- **BullMQ Worker Enhancement**: Added status tracking and progress updates to Redis-based job workers
- **Manual Job Execution**: Implemented secure API endpoint for administrative job triggering with proper error handling

### Frontend Improvements
- **Error State Management**: Added proper error state management in transaction and logo components
- **Real-time Validation**: Enhanced form components to display validation errors in real-time
- **Error Message Parsing**: Intelligent parsing of both legacy and modern error message formats
- **Debug Logging**: Comprehensive debug logging for easier development and troubleshooting
- **Responsive Design System**: Implemented comprehensive mobile-first responsive design across admin interfaces
- **Wallet Hook Safety**: Added comprehensive error boundaries and fallback states for wallet operations
- **Binary Trading UX**: Enhanced sidebar collapse behavior with smooth animations and proper state management
- **Touch-Optimized UI**: Redesigned admin components with touch-friendly interactions and mobile navigation patterns

### Critical Bug Fixes
- **Cron Job Execution**: Resolved critical issue where cron jobs appeared permanently "idle" despite executing correctly
- **Status Synchronization**: Fixed disconnect between WebSocket broadcasts and actual job object status
- **Redis Dependency**: Identified and documented Redis server requirement for proper cron job functionality
- **Wallet Connection**: Resolved TypeError crashes in wallet tab when hooks were not properly initialized
- **Mobile Accessibility**: Fixed numerous responsive design issues affecting mobile and tablet users

### Performance Optimizations
- **Cron Interface**: Optimized cron management page for better performance on mobile devices
- **Component Efficiency**: Improved component rendering with better memo usage and state management
- **Image Processing**: Enhanced logo upload processing with more efficient Sharp configuration
- **Error Handling**: Reduced unnecessary re-renders and improved error recovery patterns