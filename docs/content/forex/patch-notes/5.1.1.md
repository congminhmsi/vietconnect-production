# Forex v5.1.1
**Release Date:** August 3, 2025  
**Tags:** SECURITY, BUG FIXES, PERFORMANCE, AUDIT

## Critical Security Fixes
- **Wallet Balance Calculation in LOSS Cases**: Fixed critical bug where losing investments incorrectly calculated remaining wallet balance, preventing financial discrepancies
- **User Ownership Validation**: Added comprehensive validation across all forex account endpoints to prevent unauthorized access to other users' accounts
- **Investment Constraint Issues**: Resolved unique constraint problems allowing users to have multiple active investments per plan as intended

## Financial Security Enhancements
- **Rate Limiting Implementation**: Added robust rate limiting across all financial operations (5 requests/minute for transactions, 10/hour for investments)
- **Comprehensive Audit Logging**: Implemented complete audit trail system logging all financial operations with IP tracking and user-agent details
- **Fraud Detection System**: Deployed advanced fraud detection monitoring unusual activity patterns, high amounts, and rapid transactions with risk scoring
- **Withdrawal Limits**: Implemented daily ($5,000) and monthly ($50,000) withdrawal limits with automatic reset mechanisms

## System Reliability Improvements
- **Error Recovery Mechanism**: Added retry system with exponential backoff for failed investment processing and manual intervention endpoints
- **Database Performance**: Added critical indexes on userId, status, createdAt, and endDate fields across all forex models
- **Pagination Support**: Implemented consistent pagination across all list endpoints for better performance and user experience
- **Transaction Handler Refactoring**: Extracted common deposit/withdrawal logic into shared utilities reducing code duplication and improving maintainability

## User Experience Enhancements
- **Investment Terms Compliance**: Added mandatory terms acceptance with version tracking (termsAcceptedAt, termsVersion) for regulatory compliance
- **Two-Phase Transaction Flow**: Validated and documented proper admin approval workflow for all deposit/withdrawal operations
- **Enhanced Error Handling**: Improved error messages and validation across all financial operations
- **Type Safety**: Complete TypeScript implementation with proper type definitions for all forex-related operations

## Technical Infrastructure
- **Metadata Tracking**: Added comprehensive metadata fields for error tracking and debugging in investment records
- **Request Context**: Enhanced Handler interface with IP tracking and header access for fraud detection
- **Chain Parameter Validation**: Improved blockchain network parameter handling with proper type checking
- **Sequelize Compliance**: Fixed all model validator configurations for database integrity

## Performance Optimizations
- **Query Performance**: Database indexes significantly improve query performance for forex operations
- **Memory Usage**: Refactored duplicate code reducing memory footprint and improving execution efficiency
- **Transaction Processing**: Optimized investment processing cron with better error handling and recovery

## Compliance & Audit Features
- **Complete Audit Trail**: Every forex operation is now logged with full context including user, IP, amount, and timestamp
- **Terms Tracking**: Investment terms acceptance is tracked with timestamps and version numbers for compliance
- **Risk Assessment**: Fraud detection system provides risk scores for manual review of suspicious activities
- **Admin Oversight**: Enhanced admin tools for monitoring and approving high-risk transactions